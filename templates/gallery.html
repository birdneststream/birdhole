<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birdhole Gallery</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#21252b">
    <link rel="icon" href="/static/icons/favicon.ico" sizes="any">
    <link rel="icon" href="/static/icons/favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="icon" href="/static/icons/favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">    
    <script src="/static/js/htmx.min.js" defer></script> 
</head>
<body>
    <header>
        <h1>Birdhole Gallery</h1>
        <!-- Add search/filter controls here if needed later -->
    </header>

    {{/* Define the content block that can be swapped by polling */}}
    {{ block "gallery-content" . }}
    <div id="gallery-content" 
         hx-get="/gallery?partial=true{{if .CurrentKey}}&key={{.CurrentKey}}{{end}}" {{/* Poll full gallery with partial flag */}}
         hx-include="[name='key'], [name='tag'], [name='mime'], [name='sort'], [name='q']" {{/* Include current filters */}}
         hx-trigger="every 60s" 
         hx-swap="outerHTML" {{/* Swap the whole content div */}}
         hx-indicator=".htmx-indicator"> 
        <nav>
            <div class="filter-controls"> 
                {{/* NEW: Left Panel for Filters */}}
                <div class="filter-panel-left">
                    
                    {{/* REVISED: Checkbox Filters for Types */}}
                    <div class="checkbox-filters">
                        <div class="show-types"> {{/* Keep class for styling consistency? Or rename? Let's keep for now */}}
                            <span>Filter by Type:</span> {{/* Renamed Label */}}
                            <div class="checkbox-group" 
                                 hx-get="/gallery/items" 
                                 hx-include="[name='key'], [name='tag'], [name='sort'], [name='q'], [name='show_type']" {{/* Removed hide_type */}} 
                                 hx-target="#gallery-items" 
                                 hx-swap="outerHTML:#gallery-items:transition:true"
                                 hx-trigger="change from:input"
                                 hx-push-url="true"
                                 hx-indicator=".htmx-indicator">
                                {{ range $index, $mime := .UniqueMimeTypes }}
                                <label>
                                    {{/* Logic: Check if ActiveShowMimes is empty (show all) OR if current mime is in ActiveShowMimes */}}
                                    <input type="checkbox" name="show_type" value="{{ . }}" 
                                           {{ if or (not $.ActiveShowMimes) (isInList . $.ActiveShowMimes) }}checked{{ end }}>
                                    {{ . }}
                                </label>
                                {{ end }}
                            </div>
                        </div>
                        {{/* REMOVED Hide Types Section */}}
                    </div>

                    {{/* NEW: Container for Sort and Search */}}
                    <div class="sort-search-container">
                        {{/* MOVED: Select and Search Filters */}}
                        <div class="select-filters">
                            <label for="sortOrder">Sort by:</label>
                            <select id="sortOrder" 
                                    name="sort"
                                    hx-get="/gallery/items" 
                                    hx-include="[name='key'], [name='tag'], [name='show_type'], [name='q']" 
                                    hx-target="#gallery-items" 
                                    hx-swap="outerHTML:#gallery-items:transition:true"
                                    hx-trigger="change"
                                    hx-push-url="true"
                                    hx-indicator=".htmx-indicator">
                                <option value="new" {{ if ne .SortOrder "old" }}selected{{ end }}>Newest</option>
                                <option value="old" {{ if eq .SortOrder "old" }}selected{{ end }}>Oldest</option>
                            </select>
                        </div>
                        <div class="search-filter"> 
                            <label for="searchQuery">Search:</label> 
                            <input type="search" 
                                   id="searchQuery" 
                                   name="q" 
                                   placeholder="Search name/desc..." 
                                   value="{{ .SearchQuery }}" 
                                   hx-get="/gallery/items" 
                                   hx-include="[name='key'], [name='tag'], [name='show_type'], [name='sort']" 
                                   hx-target="#gallery-items" 
                                   hx-swap="outerHTML:#gallery-items:transition:true"
                                   hx-trigger="keyup changed delay:500ms, search" 
                                   hx-push-url="true"
                                   hx-indicator=".htmx-indicator">
                        </div>
                    </div> {{/* End Sort and Search Container */}}

                </div> {{/* End Left Panel */}}

                {{/* NEW: Right Panel for Tags */}}
                <div class="filter-panel-right">
                    <div class="tag-filters">
                        <span>Tags:</span>
                        <div id="tag-link-list"> {{/* Container for OOB swap */}}
                        <a href="/gallery?key={{ .CurrentKey }}" 
                           hx-get="/gallery/items" 
                           hx-include="[name='key'], [name='show_type'], #sortOrder, #searchQuery" {{/* Removed hide_type */}} 
                           hx-vals='{"tag": ""}' 
                           hx-target="#gallery-items" 
                           hx-push-url="true" 
                           hx-swap="outerHTML:#gallery-items:transition:true" 
                           hx-indicator=".htmx-indicator" 
                           {{ if eq .ActiveTag "" }}class="active"{{ end }}>All</a>
                        {{ range .UniqueTags }}
                        <a 
                            href="/gallery?key={{ $.CurrentKey }}&tag={{ . }}" 
                            hx-get="/gallery/items" 
                            hx-include="[name='key'], [name='show_type'], #sortOrder, #searchQuery" {{/* Removed hide_type */}} 
                            hx-vals='{"tag": "{{ . }}"}' 
                            hx-target="#gallery-items" 
                            hx-push-url="true" 
                            hx-swap="outerHTML:#gallery-items:transition:true" 
                            hx-indicator=".htmx-indicator" 
                            {{ if eq $.ActiveTag . }}class="active"{{ end }}>#{{ . }}</a>
                        {{ end }}
                        </div> {{/* End #tag-link-list */}}
                    </div>
                </div> {{/* End Right Panel */}}
            </div>

            {{/* Hidden inputs to store current filter state */}}
            {{/* We now rely on hx-include to get values directly from inputs/selects */}}
            {{/* Might need hidden inputs if state needs to be preserved across full page loads differently */}}
            {{/* <input type="hidden" name="tag" value="{{ .ActiveTag }}"> */}}
            {{/* <input type="hidden" name="mime" value="{{ .ActiveMime }}"> */}} {{/* Replaced by show/hide */}}
            {{/* <input type="hidden" name="sort" value="{{ .SortOrder | default "new" }}"> */}}
            {{/* <input type="hidden" name="q" value="{{ .SearchQuery }}"> */}}
            <input type="hidden" name="key" value="{{ .CurrentKey }}">

        </nav>

        <main>
            {{/* Loading indicator: Moved outside swapped area? Or keep inside? Let's keep inside for now */}}
            <div class="htmx-indicator loading-indicator">Loading gallery items...</div> 

            <div id="gallery-items" 
                 {{/* hx-get removed - polling is now on #gallery-content */}} 
                 {{/* hx-trigger removed */}}
                 {{/* hx-swap removed */}}
                 >
                {{/* Render initial items directly */}}
                {{ template "gallery_items.html" . }}
            </div>
        </main>
    </div> {{/* End #gallery-content */}}
    {{ end }} {{/* End block "gallery-content" */}}

</body>
</html>

{{ define "gallery_items.html" }}
    {{ if not .Files }}
        <p>No files found.</p>
    {{ else }}
        {{ range .Files }}
        <div class="gallery-item">
            <a href="/detail/{{ .Name }}?key={{ $.CurrentKey }}">
                {{ if eq (printf "%.5s" .MimeType) "image" }}
                    <img src="/thumbnail/{{ .Name }}" alt="{{ .Description }}">
                {{ else if eq (printf "%.5s" .MimeType) "video" }}
                    <video muted loop autoplay playsinline src="/{{ .Name }}" title="{{ .Name }}"></video>
                {{ else if eq (printf "%.5s" .MimeType) "audio" }}
                     <span class="gallery-item-icon">&#127925;</span>
                {{ else if eq (printf "%.4s" .MimeType) "text" }}
                     <div class="gallery-item-text-snippet">{{ .Snippet | default "(Text file)" }}</div>
                {{ else }}
                    <span class="gallery-item-icon">&#128196;</span>
                {{ end }}
                
                <div class="gallery-item-details">
                    <p title="{{ .Name }}"><strong>File:</strong> {{ .Name }}</p>
                    <p><strong>Size:</strong> {{ formatBytes .Size }}</p>
                    {{ if .Tags }}
                    <p title="{{ range $i, $tag := .Tags }}{{ if $i }} {{ end }}#{{ $tag }}{{ end }}"><strong>Tags:</strong> {{ range $i, $tag := .Tags }}{{ if $i }}, {{ end }}#{{ $tag }}{{ end }}</p>
                    {{ end }}
                    {{ if .Description }}
                    <p title="{{ .Description }}"><strong>Desc:</strong> {{ .Description }}</p>
                    {{ end }}
                </div>
            </a>
            {{ if $.IsAdmin }}
                <button class="gallery-item-delete-button" 
                        hx-delete="/{{ .Name }}?key={{ $.CurrentKey }}" 
                        hx-confirm="Are you sure you want to delete {{ .Name }}?" 
                        hx-target="closest .gallery-item" 
                        hx-swap="outerHTML">X</button>
            {{ end }}
        </div>
        {{ end }}
    {{ end }}
{{ end }}

{{/* Define block for Out-of-Band swap of tag links */}}
{{ define "tag_links_oob.html" }}
<div id="tag-link-list" hx-swap-oob="true"> {{/* Target for OOB swap */}}
    <a href="/gallery?key={{ .CurrentKey }}" 
       hx-get="/gallery/items" 
       hx-include="[name='key'], [name='show_type'], #sortOrder, #searchQuery" {{/* Removed hide_type */}} 
       hx-vals='{"tag": ""}' 
       hx-target="#gallery-items" 
       hx-push-url="true" 
       hx-swap="outerHTML:#gallery-items:transition:true" 
       hx-indicator=".htmx-indicator" 
       {{ if eq .ActiveTag "" }}class="active"{{ end }}>All</a>
    {{ range .UniqueTags }}
    <a 
        href="/gallery?key={{ $.CurrentKey }}&tag={{ . }}" 
        hx-get="/gallery/items" 
        hx-include="[name='key'], [name='show_type'], #sortOrder, #searchQuery" {{/* Removed hide_type */}} 
        hx-vals='{"tag": "{{ . }}"}' 
        hx-target="#gallery-items" 
        hx-push-url="true" 
        hx-swap="outerHTML:#gallery-items:transition:true" 
        hx-indicator=".htmx-indicator" 
        {{ if eq $.ActiveTag . }}class="active"{{ end }}>#{{ . }}</a>
    {{ end }}
</div>
{{ end }} 